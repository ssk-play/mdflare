# MDFlare Architecture

> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2026-02-09

---

## ğŸ“‹ ê°œìš”

MDFlareëŠ” ë¡œì»¬ ë§ˆí¬ë‹¤ìš´ í´ë”ë¥¼ í´ë¼ìš°ë“œì™€ ì‹¤ì‹œê°„ ë™ê¸°í™”í•˜ê³  ì›¹ì—ì„œ í¸ì§‘í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

**í•µì‹¬ ì² í•™:**
- ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë½ì¸ ì—†ìŒ)
- Cloudflare ë¬´ë£Œ í‹°ì–´ë¡œ ìš´ì˜ ê°€ëŠ¥
- ì˜¤í”„ë¼ì¸ ìš°ì„  (ë¡œì»¬ì´ ì§„ì‹¤ì˜ ì›ì²œ)

---

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              í´ë¼ì´ì–¸íŠ¸                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  ì›¹ ë¸Œë¼ìš°ì €  â”‚          â”‚ macOS Agent â”‚          â”‚  (ì˜ˆì •)      â”‚      â”‚
â”‚  â”‚  (React)    â”‚          â”‚  (Rust)     â”‚          â”‚ Win/Linux   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                        â”‚                                       â”‚
â”‚         â”‚ HTTPS                  â”‚ HTTPS + FSEvents                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                        â”‚
          â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Cloudflare Edge                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   Cloudflare Pages                               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚ Static Site â”‚    â”‚           Pages Functions               â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ (React App) â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”‚
â”‚  â”‚  â”‚             â”‚    â”‚  â”‚ /api/*  â”‚ â”‚ /token  â”‚ â”‚ /_tunnel  â”‚ â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”˜    â”‚
â”‚                                â”‚           â”‚            â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                             â–¼           â–¼            â–¼             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                    Cloudflare R2                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  /{uid}/                                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â”€ notes/                  # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë“¤                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”‚   â”œâ”€â”€ welcome.md                                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”‚   â””â”€â”€ ideas/roadmap.md                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€â”€ _meta/                  # ë©”íƒ€ë°ì´í„° (ê³µê°œ ì„¤ì • ë“±)       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€â”€ _orphanage/             # ì¶©ëŒ ì‹œ ë°±ì—… (30ì¼ ë³´ê´€)       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  _usernames/{username}         # ìœ ì €ë„¤ì„ â†’ UID ë§¤í•‘           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  _tokens/{tokenHash}           # API í† í° ì €ì¥                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                            Cloudflare Bindings                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Firebase                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Firebase Auth       â”‚    â”‚ Firebase Realtime Database              â”‚ â”‚
â”‚  â”‚ (Google ë¡œê·¸ì¸)      â”‚    â”‚ /users/{uid}/                           â”‚ â”‚
â”‚  â”‚                     â”‚    â”‚   â”œâ”€â”€ files/{path}/                     â”‚ â”‚
â”‚  â”‚ - ID Token ë°œê¸‰     â”‚    â”‚   â”‚   â”œâ”€â”€ hash: "abc123"                â”‚ â”‚
â”‚  â”‚ - JWT ê²€ì¦ ê°€ëŠ¥     â”‚    â”‚   â”‚   â””â”€â”€ modified: 1707400000          â”‚ â”‚
â”‚  â”‚                     â”‚    â”‚   â””â”€â”€ lastSync: 1707400000              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  Realtime DB ì—­í• :                                                       â”‚
â”‚  - íŒŒì¼ ë³€ê²½ ê°ì§€ (í´ë¼ì´ì–¸íŠ¸ê°€ êµ¬ë…)                                       â”‚
â”‚  - ë©”íƒ€ë°ì´í„° ì €ì¥ (í•´ì‹œ, ìˆ˜ì •ì‹œê°„)                                         â”‚
â”‚  - ì¶©ëŒ ê°ì§€ìš© ë²„ì „ ê´€ë¦¬                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© ì»´í¬ë„ŒíŠ¸ ìƒì„¸

### 1. Web Frontend (React)

**ìœ„ì¹˜:** `web/src/`

| íŒŒì¼ | ì—­í•  |
|------|------|
| `App.jsx` | ë¼ìš°íŒ…, ì „ì—­ ìƒíƒœ |
| `pages/Landing.jsx` | ëœë”© í˜ì´ì§€, Private Vault ì—°ê²° |
| `pages/Workspace.jsx` | ì—ë””í„° ë©”ì¸, íŒŒì¼ íŠ¸ë¦¬, CodeMirror |
| `pages/SetUsername.jsx` | ìœ ì €ë„¤ì„ ë“±ë¡ |
| `pages/AgentAuth.jsx` | ì—ì´ì „íŠ¸ ì¸ì¦ í”Œë¡œìš° |
| `pages/Download.jsx` | ì—ì´ì „íŠ¸ ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ |
| `components/AgentStatus.jsx` | ì—ì´ì „íŠ¸ ì—°ê²° ìƒíƒœ í‘œì‹œ |
| `firebase.js` | Firebase ì´ˆê¸°í™”, Auth, RTDB ì—°ë™ |

**ì£¼ìš” ê¸°ëŠ¥:**
- CodeMirror 6 ê¸°ë°˜ ë§ˆí¬ë‹¤ìš´ ì—ë””í„°
- 1ì´ˆ debounce ìë™ ì €ì¥
- íŒŒì¼ íŠ¸ë¦¬ ë“œë˜ê·¸ & ë“œë¡­
- Edit / Split / Preview 3ëª¨ë“œ
- RTDB êµ¬ë…ìœ¼ë¡œ ì‹¤ì‹œê°„ ë³€ê²½ ê°ì§€

### 2. Cloudflare Pages Functions (API)

**ìœ„ì¹˜:** `web/functions/`

```
functions/
â”œâ”€â”€ _tunnel/[[path]].js        # Private Vault í„°ë„ í”„ë¡ì‹œ
â”œâ”€â”€ lib/auth.js                # JWT ê²€ì¦, API í† í° ê²€ì¦
â””â”€â”€ api/
    â”œâ”€â”€ token/
    â”‚   â””â”€â”€ agent.js           # ì—ì´ì „íŠ¸ í† í° ë°œê¸‰
    â”œâ”€â”€ username/
    â”‚   â”œâ”€â”€ check.js           # ìœ ì €ë„¤ì„ ì¤‘ë³µ ì²´í¬
    â”‚   â”œâ”€â”€ register.js        # ìœ ì €ë„¤ì„ ë“±ë¡
    â”‚   â””â”€â”€ resolve.js         # ìœ ì €ë„¤ì„ â†’ UID ë³€í™˜
    â””â”€â”€ [userId]/
        â”œâ”€â”€ _middleware.js     # ì¸ì¦/ì¸ê°€ ë¯¸ë“¤ì›¨ì–´
        â”œâ”€â”€ files.js           # íŒŒì¼ ëª©ë¡ ì¡°íšŒ
        â”œâ”€â”€ file/[[path]].js   # íŒŒì¼ CRUD
        â”œâ”€â”€ rename.js          # íŒŒì¼/í´ë” ì´ë¦„ ë³€ê²½
        â”œâ”€â”€ sync-config.js     # ë™ê¸°í™” ì„¤ì •
        â”œâ”€â”€ agent-status.js    # ì—ì´ì „íŠ¸ ìƒíƒœ ì¡°íšŒ
        â””â”€â”€ share/[[path]].js  # ê³µê°œ ê³µìœ  ì„¤ì •
```

**ì¸ì¦ íë¦„:**
```
1. ìš”ì²­ â†’ _middleware.js
2. username â†’ UID ë¦¬ì¡¸ë¸Œ (_usernames/{username})
3. Authorization í—¤ë” ì¶”ì¶œ
4. Firebase ID Token ê²€ì¦ (JWT ê³µê°œí‚¤)
   â””â”€ ì‹¤íŒ¨ ì‹œ â†’ API Token ê²€ì¦ (_tokens/{hash})
5. ì†Œìœ ì ì—¬ë¶€ íŒì • â†’ context.data.isOwner
6. ì“°ê¸° ìš”ì²­ì€ ì†Œìœ ìë§Œ í—ˆìš©
7. ì½ê¸° ìš”ì²­ì€ ê³µê°œ íŒŒì¼ ì²´í¬ í›„ í—ˆìš©
```

### 3. Desktop Agent (Rust)

**ìœ„ì¹˜:** `agent/`

**ê¸°ìˆ  ìŠ¤íƒ:**
- `axum` - ë¡œì»¬ HTTP ì„œë²„
- `tao` + `tray-icon` + `muda` - ì‹œìŠ¤í…œ íŠ¸ë ˆì´
- `notify-debouncer-mini` - íŒŒì¼ ì‹œìŠ¤í…œ ê°ì‹œ
- `reqwest` - HTTP í´ë¼ì´ì–¸íŠ¸
- `tokio` - ë¹„ë™ê¸° ëŸ°íƒ€ì„

**ë™ì‘ ëª¨ë“œ:**

| ëª¨ë“œ | ì„¤ëª… |
|------|------|
| **Cloud** | mdflare.comê³¼ ë™ê¸°í™”, ê³„ì • í•„ìš” |
| **Private Vault** | ë¡œì»¬ ì„œë²„ë§Œ, í„°ë„ë¡œ ì™¸ë¶€ ì ‘ì† |

**Cloud ëª¨ë“œ íë¦„:**
```
1. ì„¤ì •ì—ì„œ username + API í† í° ë¡œë“œ
2. FSEventsë¡œ ë¡œì»¬ í´ë” ê°ì‹œ
3. ë³€ê²½ ê°ì§€ â†’ PUT /api/{username}/file/{path}
4. ì£¼ê¸°ì  í´ë§ìœ¼ë¡œ ì›ê²© ë³€ê²½ ë‹¤ìš´ë¡œë“œ
5. Firebase RTDBì— ë©”íƒ€ë°ì´í„° ê¸°ë¡
```

**Private Vault ëª¨ë“œ íë¦„:**
```
1. ë¡œì»¬ HTTP ì„œë²„ ì‹œì‘ (í¬íŠ¸ 7779)
2. cloudflared Quick Tunnel ì‹œì‘
3. trycloudflare.com URL íšë“
4. ì—°ê²° í† í° ìƒì„± (base64(url|token))
5. ì›¹ì—ì„œ í† í°ìœ¼ë¡œ í„°ë„ í†µí•´ ì ‘ì†
```

**ì£¼ìš” êµ¬ì¡°ì²´:**
```rust
struct Config {
    storage_mode: StorageMode,  // Cloud | PrivateVault
    local_path: String,         // ë™ê¸°í™” ëŒ€ìƒ í´ë”
    username: String,           // Cloud ëª¨ë“œ
    api_token: String,          // Cloud ëª¨ë“œ
    server_port: u16,           // Private Vault ëª¨ë“œ
    server_token: String,       // Private Vault ëª¨ë“œ
}

struct AppState {
    config: Arc<Mutex<Config>>,
    sync_status: Arc<Mutex<SyncStatus>>,
    // ...
}
```

### 4. Firebase

**Firebase Auth:**
- Google ë¡œê·¸ì¸ ì œê³µì
- ID Token (JWT) ë°œê¸‰
- Cloudflareì—ì„œ ê³µê°œí‚¤ë¡œ ê²€ì¦

**Firebase Realtime Database:**
```
/users/{uid}/
  â”œâ”€â”€ files/
  â”‚   â””â”€â”€ {encodedPath}/
  â”‚       â”œâ”€â”€ hash: string       # íŒŒì¼ ë‚´ìš© í•´ì‹œ
  â”‚       â””â”€â”€ modified: number   # ìˆ˜ì • íƒ€ì„ìŠ¤íƒ¬í”„
  â””â”€â”€ lastSync: number           # ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„
```

**ì—­í• :**
- íŒŒì¼ ë³€ê²½ ì‹¤ì‹œê°„ êµ¬ë… (ì›¹ â†” ì—ì´ì „íŠ¸)
- ì¶©ëŒ ê°ì§€ (í•´ì‹œ ë¹„êµ)
- ì˜¤í”„ë¼ì¸ â†’ ì˜¨ë¼ì¸ ì‹œ ë³€ê²½ë¶„ íŒŒì•…

---

## ğŸ”„ ë°ì´í„° íë¦„

### ë¡œì»¬ì—ì„œ íŒŒì¼ ìˆ˜ì •

```
[ë¡œì»¬] Obsidian ì €ì¥
    â†“ FSEvents
[Agent] ë³€ê²½ ê°ì§€
    â†“ PUT /api/{user}/file/{path}
[Workers] R2ì— ì €ì¥
    â†“ 
[Agent] Firebase RTDB ë©”íƒ€ë°ì´í„° ê°±ì‹ 
    â†“ onValue ì´ë²¤íŠ¸
[Web] ë³€ê²½ ê°ì§€ â†’ íŒŒì¼ ë‹¤ì‹œ ë¡œë“œ
```

### ì›¹ì—ì„œ íŒŒì¼ ìˆ˜ì •

```
[Web] íƒ€ì´í•‘ (1ì´ˆ debounce)
    â†“ PUT /api/{user}/file/{path}
[Workers] R2ì— ì €ì¥
    â†“
[Web] Firebase RTDB ë©”íƒ€ë°ì´í„° ê°±ì‹ 
    â†“ Agent í´ë§ (ë˜ëŠ” RTDB êµ¬ë…)
[Agent] ë³€ê²½ ê°ì§€ â†’ ë‹¤ìš´ë¡œë“œ
    â†“
[ë¡œì»¬] íŒŒì¼ ê°±ì‹ 
```

### ì¶©ëŒ í•´ê²°

```
[ì–‘ìª½ì—ì„œ ë™ì‹œ ìˆ˜ì •]
    â†“
[Agent] PUT ì‹œë„
    â†“
[Workers] R2 í•´ì‹œ â‰  ìš”ì²­ base í•´ì‹œ
    â†“
[Workers] ìµœì‹  íƒ€ì„ìŠ¤íƒ¬í”„ ìš°ì„ 
    â†“
[R2] íŒ¨ë°°í•œ ë²„ì „ â†’ _orphanage/ (30ì¼ ë³´ê´€)
    â†“
[Agent] ì¶©ëŒ ì•Œë¦¼ + ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ
```

---

## ğŸ” ë³´ì•ˆ ì•„í‚¤í…ì²˜

### ì¸ì¦ ë°©ì‹

| í´ë¼ì´ì–¸íŠ¸ | ì¸ì¦ ìˆ˜ë‹¨ | ê²€ì¦ ë°©ì‹ |
|-----------|----------|----------|
| ì›¹ ë¸Œë¼ìš°ì € | Firebase ID Token | JWT ê³µê°œí‚¤ ê²€ì¦ |
| Desktop Agent | API Token | R2ì—ì„œ í† í° í•´ì‹œ ì¡°íšŒ |

### Firebase ID Token ê²€ì¦

```javascript
// functions/lib/auth.js
async function verifyFirebaseToken(token) {
  // 1. JWT í—¤ë”ì—ì„œ kid ì¶”ì¶œ
  // 2. Google ê³µê°œí‚¤ ì¡°íšŒ (ìºì‹±)
  // 3. ì„œëª… ê²€ì¦
  // 4. exp, aud, iss ê²€ì¦
  // 5. decoded payload ë°˜í™˜ { uid, email, ... }
}
```

### API Token

```javascript
// ìƒì„±: agent.js
const token = crypto.randomUUID();
const hash = await sha256(token);
await env.VAULT.put(`_tokens/${hash}`, JSON.stringify({ uid, created }));

// ê²€ì¦: auth.js
async function verifyApiToken(token, env) {
  const hash = await sha256(token);
  const obj = await env.VAULT.get(`_tokens/${hash}`);
  return obj ? JSON.parse(await obj.text()) : null;
}
```

### ê¶Œí•œ ëª¨ë¸

| ì‘ì—… | ì¡°ê±´ |
|------|------|
| ì½ê¸° (GET) | ì†Œìœ ì ë˜ëŠ” ê³µê°œ íŒŒì¼ |
| ì“°ê¸° (PUT/POST) | ì†Œìœ ìë§Œ |
| ì‚­ì œ (DELETE) | ì†Œìœ ìë§Œ |

---

## ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
mdflare/
â”œâ”€â”€ agent/                      # Desktop Agent (Rust)
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ build.rs                # ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ (ì•„ì´ì½˜ ë“±)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ main.rs             # ë©”ì¸ (2600+ ë¼ì¸)
â”‚   â”œâ”€â”€ macos/
â”‚   â”‚   â”œâ”€â”€ Info.plist
â”‚   â”‚   â””â”€â”€ AppIcon.icns
â”‚   â””â”€â”€ install.sh              # ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
â”‚
â”œâ”€â”€ web/                        # Web Frontend + API
â”‚   â”œâ”€â”€ src/                    # React ì•±
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â”œâ”€â”€ main.jsx
â”‚   â”‚   â”œâ”€â”€ firebase.js
â”‚   â”‚   â”œâ”€â”€ style.css
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”œâ”€â”€ functions/              # Cloudflare Pages Functions
â”‚   â”‚   â”œâ”€â”€ _tunnel/
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”œâ”€â”€ wrangler.toml           # Cloudflare ì„¤ì •
â”‚   â”œâ”€â”€ vite.config.js
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ server/                     # ë¡œì»¬ ê°œë°œ ì„œë²„
â”‚   â””â”€â”€ index.js
â”‚
â”œâ”€â”€ scripts/                    # ë¹Œë“œ/ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ release-mac.sh
â”‚   â”œâ”€â”€ release-all.sh
â”‚   â”œâ”€â”€ deploy-web.sh
â”‚   â”œâ”€â”€ bump-patch.sh
â”‚   â””â”€â”€ check-api-parity.sh
â”‚
â”œâ”€â”€ docs/                       # ë¬¸ì„œ
â”‚   â”œâ”€â”€ ARCHITECTURE.md         # (ì´ ë¬¸ì„œ)
â”‚   â”œâ”€â”€ sync-sequences.md       # ë™ê¸°í™” ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
â”‚   â”œâ”€â”€ SECURITY-REDESIGN.md    # ë³´ì•ˆ ì¬ì„¤ê³„ ìŠ¤í™
â”‚   â””â”€â”€ WINDOWS-AGENT-HANDOVER.md
â”‚
â”œâ”€â”€ VERSION                     # í˜„ì¬ ë²„ì „
â”œâ”€â”€ README.md
â”œâ”€â”€ HANDOVER.md                 # ìµœê·¼ ë³€ê²½ì‚¬í•­ í•¸ë“œì˜¤ë²„
â”œâ”€â”€ DEV.md                      # ê°œë°œ ê°€ì´ë“œ
â””â”€â”€ package.json                # ë£¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸
```

---

## ğŸš€ ë°°í¬

### Web (Cloudflare Pages)

```bash
cd web
npm run build
npx wrangler pages deploy dist --project-name=mdflare
```

ë˜ëŠ”:
```bash
./scripts/deploy-web.sh
```

### Agent (macOS)

```bash
./scripts/release-mac.sh
# â†’ MDFlare.dmg ìƒì„±
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [ë™ê¸°í™” ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨](./sync-sequences.md)
- [ë³´ì•ˆ ì¬ì„¤ê³„ ìŠ¤í™](./SECURITY-REDESIGN.md)
- [Windows Agent í•¸ë“œì˜¤ë²„](./WINDOWS-AGENT-HANDOVER.md)
- [ê°œë°œ ê°€ì´ë“œ](../DEV.md)
