# MDFlare ë³´ì•ˆ ì¬ì„¤ê³„ ë¸Œë¦¬í•‘

> ì‘ì„±: 2026-02-06 | ìƒíƒœ: ê²€í†  ëŒ€ê¸°

---

## ğŸ“‹ ìš”ì•½

**ëª©í‘œ:** ê¸°ë³¸ ë¹„ê³µê°œ â†’ ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
**í•µì‹¬:** Firebase ID Token ê²€ì¦ (JWT ì§ì ‘ íŒŒì‹±)

---

## ğŸš¨ í˜„ì¬ ë¬¸ì œì 

| ë¬¸ì œ | ì‹¬ê°ë„ | ì„¤ëª… |
|------|--------|------|
| X-Firebase-UID ìŠ¤í‘¸í•‘ | ğŸ”´ Critical | í—¤ë”ë§Œ ë³´ê³  ì¸ì¦ í†µê³¼ â†’ ìœ„ì¡° ê°€ëŠ¥ |
| í† í° ìƒì„± ë¬´ì¸ì¦ | ğŸ”´ Critical | ëˆ„êµ¬ë‚˜ íƒ€ì¸ì˜ API í† í° ë°œê¸‰ ê°€ëŠ¥ |
| GET ë¬´ì¡°ê±´ ê³µê°œ | ğŸŸ¡ Medium | ëª¨ë“  íŒŒì¼ì´ URLë§Œ ì•Œë©´ ì—´ëŒ ê°€ëŠ¥ |

---

## ğŸ—ï¸ ìƒˆ ì•„í‚¤í…ì²˜

### ì¸ì¦ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì›¹ í´ë¼ì´ì–¸íŠ¸  â”‚â”€â”€â”€â”€â–¶â”‚  Cloudflare API  â”‚â”€â”€â”€â”€â–¶â”‚  R2 Storage â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚ Firebase ID Token   â”‚ JWT ê²€ì¦
       â”‚ (Authorization)     â”‚ (ê³µê°œí‚¤ë¡œ ì„œëª… í™•ì¸)
       â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase Authâ”‚     â”‚ ê²€ì¦ëœ UID ì¶”ì¶œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê¶Œí•œ ëª¨ë¸

| ì‘ì—… | ì¸ì¦ í•„ìš” | ì¡°ê±´ |
|------|----------|------|
| **ì½ê¸° (GET)** | âœ… | ë³¸ì¸ íŒŒì¼ ë˜ëŠ” ê³µê°œ ì„¤ì •ëœ íŒŒì¼ |
| **ì“°ê¸° (PUT)** | âœ… | ë³¸ì¸ íŒŒì¼ë§Œ |
| **ì‚­ì œ (DELETE)** | âœ… | ë³¸ì¸ íŒŒì¼ë§Œ |
| **í† í° ìƒì„±** | âœ… | ë³¸ì¸ ê³„ì •ë§Œ |

### ê³µê°œ ê³µìœ  (ì„ íƒì )

```
ê¸°ë³¸: ë¹„ê³µê°œ (ë³¸ì¸ë§Œ)
     â†“ ì‚¬ìš©ìê°€ "ê³µìœ " ì„¤ì •
ê³µê°œ: URL ì•Œë©´ ëˆ„êµ¬ë‚˜ ì½ê¸° ê°€ëŠ¥ (ìˆ˜ì •ì€ ë¶ˆê°€)
```

**êµ¬í˜„ ë°©ì‹:**
- íŒŒì¼ë³„ ê³µê°œ í”Œë˜ê·¸: `_meta/{userId}/{path}.json` â†’ `{ public: true }`
- ë˜ëŠ” í´ë”ë³„: `_meta/{userId}/_public/` í•˜ìœ„ëŠ” ê³µê°œ

---

## ğŸ”§ êµ¬í˜„ ê³„íš

### Phase 1: JWT ê²€ì¦ (í•„ìˆ˜)

**1-1. ê³µí†µ ì¸ì¦ ìœ í‹¸ ìƒì„±**
```
functions/lib/auth.js
â”œâ”€â”€ verifyFirebaseToken(token) â†’ { uid, email, ... }
â”œâ”€â”€ getFirebasePublicKeys() â†’ ìºì‹±ëœ ê³µê°œí‚¤
â””â”€â”€ decodeJWT(token) â†’ payload
```

**1-2. ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì •**
```js
// í˜„ì¬ (ì·¨ì•½)
if (firebaseUid && firebaseUid === userData.uid) { ... }

// ë³€ê²½ (ì•ˆì „)
const idToken = authHeader.replace('Bearer ', '');
const decoded = await verifyFirebaseToken(idToken, env);
if (decoded.uid === userData.uid) { ... }
```

**1-3. í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì •**
```js
// í˜„ì¬
headers['X-Firebase-UID'] = auth.currentUser.uid;

// ë³€ê²½
const idToken = await auth.currentUser.getIdToken();
headers['Authorization'] = `Bearer ${idToken}`;
```

### Phase 2: ì½ê¸° ê¶Œí•œ (í•„ìˆ˜)

**2-1. GET ìš”ì²­ë„ ì¸ì¦ í•„ìš”**
```js
// ë¯¸ë“¤ì›¨ì–´ì—ì„œ
if (method === 'GET') {
  // ì¸ì¦ ìˆìœ¼ë©´ â†’ ë³¸ì¸ í™•ì¸
  // ì¸ì¦ ì—†ìœ¼ë©´ â†’ ê³µê°œ íŒŒì¼ì¸ì§€ í™•ì¸
  // ë‘˜ ë‹¤ ì•„ë‹ˆë©´ â†’ 403
}
```

**2-2. ê³µê°œ ì„¤ì • API**
```
PUT /api/{userId}/share/{path}
Body: { public: true/false }
```

### Phase 3: í† í° API ë³´í˜¸ (í•„ìˆ˜)

```js
// /api/token/generate
const decoded = await verifyFirebaseToken(idToken, env);
if (decoded.uid !== body.uid) {
  return Response.json({ error: 'Unauthorized' }, { status: 403 });
}
```

---

## ğŸ“ ë³€ê²½ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|----------|
| `functions/lib/auth.js` | ğŸ†• JWT ê²€ì¦ ìœ í‹¸ |
| `functions/api/[userId]/_middleware.js` | ì¸ì¦ ë¡œì§ ì „ë©´ êµì²´ |
| `functions/api/[userId]/file/[[path]].js` | GET ê¶Œí•œ ì²´í¬ ì¶”ê°€ |
| `functions/api/[userId]/share/[[path]].js` | ğŸ†• ê³µê°œ ì„¤ì • API |
| `functions/api/token/generate.js` | ì¸ì¦ ì¶”ê°€ |
| `functions/api/token/agent.js` | ì¸ì¦ ì¶”ê°€ |
| `src/pages/Workspace.jsx` | ID Token ì „ì†¡ìœ¼ë¡œ ë³€ê²½ |
| `src/firebase.js` | getIdToken í—¬í¼ ì¶”ê°€ |

---

## â±ï¸ ì˜ˆìƒ ì†Œìš” ì‹œê°„

| Phase | ì‘ì—… | ì‹œê°„ |
|-------|------|------|
| 1 | JWT ê²€ì¦ êµ¬í˜„ | 30ë¶„ |
| 2 | ì½ê¸° ê¶Œí•œ + ê³µê°œ ì„¤ì • | 20ë¶„ |
| 3 | í† í° API ë³´í˜¸ | 10ë¶„ |
| - | í…ŒìŠ¤íŠ¸ | 15ë¶„ |
| **í•©ê³„** | | **~1ì‹œê°„ 15ë¶„** |

---

## â“ ê²°ì • í•„ìš” ì‚¬í•­

1. **ê³µê°œ ê³µìœ  UI**
   - [ ] íŒŒì¼ë³„ ê³µìœ  ë²„íŠ¼ ì¶”ê°€?
   - [ ] ê³µìœ  ë§í¬ ë³µì‚¬ ì‹œ ìë™ ê³µê°œ?
   - [ ] ê³µê°œ íŒŒì¼ í‘œì‹œ ì•„ì´ì½˜?

2. **ê¸°ì¡´ íŒŒì¼ ì²˜ë¦¬**
   - [ ] ëª¨ë‘ ë¹„ê³µê°œë¡œ ì „í™˜ (ê¸°ë³¸)
   - [ ] ê¸°ì¡´ íŒŒì¼ì€ ê³µê°œ ìœ ì§€?

3. **ì—ì´ì „íŠ¸ í† í°**
   - [ ] ì—ì´ì „íŠ¸ë„ ì½ê¸° ê¶Œí•œ í•„ìš” (í˜„ì¬ëŠ” ì“°ê¸°ë§Œ ì¸ì¦)

---

## âœ… ìŠ¹ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì•„í‚¤í…ì²˜ ìŠ¹ì¸
- [ ] ê³µê°œ ê³µìœ  ì •ì±… ê²°ì •
- [ ] ê¸°ì¡´ íŒŒì¼ ì²˜ë¦¬ ë°©ì‹ ê²°ì •
- [ ] êµ¬í˜„ ì°©ìˆ˜ ìŠ¹ì¸

---

**ê²€í†  í›„ ì§„í–‰ ì§€ì‹œ ë¶€íƒë“œë¦½ë‹ˆë‹¤!** ğŸ™
