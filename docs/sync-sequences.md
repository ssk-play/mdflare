# MDFlare 동기화 시퀀스 다이어그램

## 1. 최초 가입 — R2 생성

```
User          Web           Workers        R2
 │             │              │             │
 ├─ 가입 ─────→│              │             │
 │             ├─ POST /signup→│             │
 │             │              ├─ 버킷 생성 ──→│ (비어있음)
 │             │              │←── 생성완료 ──┤
 │             │←── 완료 ─────┤             │
 │←── 대시보드 ─┤              │             │
 │             │              │             │
 │  "로컬 에이전트를 설치하세요"  │             │
```

## 2. 로컬 에이전트 최초 연결 — 전체 업로드

```
Agent(Mac)     Workers        R2
 │              │             │
 ├─ 인증 ──────→│             │
 │←── 토큰 ────┤             │
 │              │             │
 ├─ GET /files ─→│             │
 │              ├─ list ──────→│
 │              │←── [] 비어있음┤
 │←── 빈 목록 ──┤             │
 │              │             │
 │ [로컬 폴더 스캔: 50개 .md]  │
 │              │             │
 ├─ PUT file1 ──→│             │
 │              ├─ put ───────→│ ✅
 ├─ PUT file2 ──→│             │
 │              ├─ put ───────→│ ✅
 │   ...        │    ...       │
 ├─ PUT file50 ─→│             │
 │              ├─ put ───────→│ ✅
 │              │             │
 │  [최초 동기화 완료]          │ (50개 보유)
```

## 3. 로컬에서 파일 수정

```
User       Agent(Mac)     Workers        R2           Web(열려있음)
 │          │              │             │              │
 ├─ 파일수정→│              │             │              │
 │          │ [FSEvents 감지]             │              │
 │          ├─ PUT file ───→│             │              │
 │          │              ├─ put ───────→│ ✅           │
 │          │←── 저장완료 ──┤             │              │
 │          │              │             │              │
 │          │              │     [웹이 폴링 or 포커스]    │
 │          │              │             │←── GET file ──┤
 │          │              │             ├─── 최신내용 ──→│
 │          │              │             │              │ ✅ 화면 갱신
```

## 4. 웹에서 파일 수정

```
User       Web            Workers        R2           Agent(Mac)
 │          │              │             │              │
 ├─ 타이핑 ─→│              │             │              │
 │          │ [1초 debounce]│             │              │
 │          ├─ PUT file ───→│             │              │
 │          │              ├─ put ───────→│ ✅           │
 │          │←── 저장완료 ──┤             │              │
 │          │              │             │              │
 │          │              │   [에이전트 폴링]            │
 │          │              │             │←── 변경체크 ──┤
 │          │              │             ├── 변경있음 ───→│
 │          │              │             │              │ [로컬 파일 갱신]
 │          │              │             │              ├─ ✅ 로컬 반영
```

## 5. 로컬 꺼짐 → 웹에서 수정 → 로컬 다시 켜짐

```
Agent(Mac)     Web            Workers        R2
 │              │              │             │
 ╳ [PC 종료]    │              │             │
                │              │             │
        User───→│              │             │
                ├─ PUT fileA ──→│             │
                │              ├─ put ───────→│ ✅
                ├─ PUT fileB ──→│             │
                │              ├─ put ───────→│ ✅
                │              │             │
  ... 3시간 후 ...              │             │
                │              │             │
 │ [PC 켜짐]    │              │             │
 │              │              │             │
 │ [에이전트 자동 시작]          │             │
 ├─ GET /files ─────────────────→│            │
 │              │              │←── 전체목록 ─┤
 │←── 파일목록 + 수정시간 ──────┤             │
 │              │              │             │
 │ [로컬과 비교]  │              │             │
 │ fileA: R2가 최신 → 다운로드   │             │
 ├─ GET fileA ──────────────────→│            │
 │              │              │←── 내용 ────┤
 │←── 내용 ────────────────────┤             │
 │ [로컬 fileA 갱신] ✅         │             │
 │              │              │             │
 │ fileB: R2가 최신 → 다운로드   │             │
 ├─ GET fileB ──────────────────→│            │
 │←── 내용 ────────────────────┤             │
 │ [로컬 fileB 갱신] ✅         │             │
```

## 6. 충돌 — 양쪽 동시 수정

```
Agent(Mac)     Web            Workers        R2           Orphanage
 │              │              │             │              │
 ╳ [PC 종료]    │              │             │              │
                │              │             │              │
        User───→│              │             │              │
                ├─ PUT readme ─→│             │              │
                │  (v2-web)    ├─ put ───────→│ v2-web       │
                │              │             │              │
  ... PC 꺼진 동안 로컬에서도 수정했었음 ...     │              │
                │              │             │              │
 │ [PC 켜짐]    │              │             │              │
 │ readme (v2-local)           │             │              │
 │              │              │             │              │
 ├─ PUT readme ────────────────→│             │              │
 │  (v2-local)  │              │             │              │
 │              │              │ [충돌 감지!]  │              │
 │              │              │ R2: v2-web   │              │
 │              │              │ 요청: v2-local│              │
 │              │              │             │              │
 │              │              │ [우선순위 정책: 최신 타임스탬프]│
 │              │              │             │              │
 │              │              │ v2-web이 최신→│              │
 │              │              ├─ v2-local ──────────────────→│ 고아원 보관
 │              │              │             │              │ (30일)
 │              │              │             │              │
 │←── 충돌알림: "R2 버전 유지, 로컬 버전은 고아원"──┤          │
 │              │              │             │              │
 │ [R2 버전으로 로컬 갱신]       │             │              │
 ├─ GET readme ────────────────→│             │              │
 │←── v2-web ──────────────────┤             │              │
 │ ✅ 로컬 = v2-web             │             │              │
```

## 7. 멀티 로컬 — Mac 2대

```
Agent-A(집)     Agent-B(사무실)   Workers        R2
 │               │                │             │
 ├─ PUT file ───→│                │             │
 │  (수정)       │               ├─ put ───────→│ ✅
 │               │                │             │
 │               │ [폴링]         │             │
 │               ├─ 변경체크 ─────→│             │
 │               │                ├─ list ──────→│
 │               │                │←── 변경있음 ─┤
 │               │←── 변경목록 ───┤             │
 │               ├─ GET file ────→│             │
 │               │←── 최신내용 ──┤             │
 │               │ [로컬 갱신] ✅  │             │
 │               │                │             │
 │  양쪽 Mac이 항상 R2와 동일      │             │
```

## 8. 멀티 웹 — 브라우저 2개

```
Web-A          Web-B          Workers        R2
 │              │              │             │
 ├─ PUT file ──→│              │             │
 │  (수정)      │             ├─ put ───────→│ ✅
 │              │              │             │
 │              │ [탭 포커스]   │             │
 │              ├─ GET file ──→│             │
 │              │              ├─ get ───────→│
 │              │              │←── 최신 ────┤
 │              │←── 최신내용 ──┤             │
 │              │ ✅ 화면 갱신   │             │
```

---

*8가지 시나리오 커버: 최초가입, 최초연결, 로컬수정, 웹수정, 재접속, 충돌, 멀티로컬, 멀티웹*
